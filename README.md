# Task Service Consumer

Этот проект представляет собой сервис-консьюмер, который обрабатывает задачи, получаемые через Kafka. Он регистрирует задачи в базе данных, запускает их выполнение, обновляет их статус и сохраняет результаты.

## Описание

Сервис прослушивает сообщения из Kafka, сохраняет полученные задачи в базе данных, а затем выполняет их асинхронно, обновляя статус задачи в процессе. Статус задачи может быть `PENDING`, `IN_PROGRESS` и `COMPLETED`.

## Требования

- Java 17
- Spring Boot
- PostgreSQL
- Apache Kafka
- Docker

## Стек технологий

- **Spring Boot**
- **Kafka**
- **Spring Data JPA**
- **Flyway**
- **Swagger**

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone https://github.com/Vitaliy5796/NexignTaskService.git
cd <папка приложения>
```

### 2. Запуск с помощью Docker

Для запуска Kafka и PostgreSQL с помощью Docker используйте docker-compose.

```bash
docker-compose -f docker-compose.yml up
```

### 3. Запуск приложения

Запустите Spring Boot приложение с помощью Maven

```bash
mvn spring-boot:run
```

## API

### 1. Регистрация задачи

Отправьте в kafka задачу в топик: "tasks".

Формат сообщения: 

```json
{
  "name": "Задача 1",
  "duration": 5000,
  "idempotencyKey" : "ik"
}
```

Преобразованный в строку с помощью objectMapper.writeValueAsString()

### 2. Просмотр статуса задачи

***GET*** `http://localhost:8081/api/task/:taskId`

Где taskId = id задачи.

Возвращает статус выполнения задачи по ее идентификатору.

```json
{
  "id": 1,
  "name": "Task 1",
  "status": "IN_PROGRESS",
  "result": "Выполнение задачи..."
}
```

### Статусы задачи
#### Задача может находиться в одном из следующих статусов:
- PENDING: Задача зарегистрирована, но еще не выполнена.
- IN_PROGRESS: Задача в процессе выполнения.
- COMPLETED: Задача выполнена успешно.
- FAILED: Задача завершена с ошибкой.

## Асинхронная обработка
Задачи выполняются асинхронно в пуле воркеров. Вы можете настроить количество воркеров в конфигурации application.yml:

```yaml
spring:
  kafka:
    listener:
      concurrency: 3  # Настроить количество воркеров
```

Так же можно указать количество потоков для обработки: 
```yaml
task-executor:
  core-pool-size: 20 # Базовое количество потоков
  max-pool-size: 50 # Максимальное количество потоков
  queue-capacity: 100 # Размер очереди задач
```

После регистрации задачи через API, сервис запускает воркеры для выполнения задач, обновляя статус в базе данных по мере выполнения.

## Swagger
Для просмотра и тестирования API, вы можете использовать Swagger. Откройте браузер и перейдите по следующему URL:

```bash
http://localhost:8081/swagger-ui/index.html#/task-controller
```

## Миграции базы данных
Для создания структуры базы данных используется Flyway. Миграции находятся в папке src/main/resources/db/migration. Flyway автоматически применяет их при запуске приложения.

# Заключение


Этот файл `README.md` включает в себя все основные этапы установки и настройки проекта, информацию о ключевых API, миграциях и использовании Swagger.
